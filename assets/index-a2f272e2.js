import{u as h,j as r,S as Q,a as A,I as v,f as w,b as q,m as M,c as b,d as U,e as D,g as Y,h as V,p as j,i as X,P as W,B as Z,O as _,k as $,l as k,F as ee,L as te}from"./index-9718ad5b.js";import{c as S}from"./clsx-a2f71979.js";import{t as a}from"./i18next-c73dc616.js";import{r as g}from"./react-11ad9974.js";import{V as re}from"./react-virtuoso-e1d9e9c1.js";import{F as se}from"./index-0fd367d4.js";import{h as T,G as ae,M as P,i as x,S as ne,c as oe,b as ie}from"./@openim-a63ca2b1.js";import{b as z,d as ce,O as le}from"./react-router-e84d70e0.js";import{j as me}from"./ahooks-0f0ed15d.js";import"./dayjs-58c5dd90.js";import"./@babel-260269db.js";import"./localforage-42b533ed.js";import"./react-i18next-61ba1977.js";import"./electron-log-39892505.js";import"./react-dom-ad405c1c.js";import"./scheduler-765c72db.js";import"./react-query-c78ce74a.js";import"./react-router-dom-28f205e1.js";import"./@remix-run-1f835eaf.js";import"./classnames-c74120a4.js";import"./@emotion-c0b5c018.js";import"./stylis-5efc5547.js";import"./@ctrl-03fa0c70.js";import"./zustand-14da06db.js";import"./use-sync-external-store-0e343eac.js";import"./twemoji-540bbbe7.js";import"./axios-26ac709a.js";import"./uuid-4a60fe23.js";import"./mitt-f7ef348c.js";import"./date-fns-27ddccf6.js";import"./react-image-file-resizer-3cc20154.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./scroll-into-view-if-needed-247ac2f3.js";import"./compute-scroll-into-view-ff36de3a.js";import"./throttle-debounce-87e7e444.js";import"./md5-ffbe311d.js";import"./crypt-5ea4a8e1.js";import"./charenc-bfd911d6.js";import"./is-buffer-793dba8c.js";import"./react-draggable-a9e3b63d.js";import"./prop-types-08c7c3df.js";import"./react-use-cc94cbd6.js";import"./copy-to-clipboard-5e8b3f9a.js";import"./toggle-selection-93f4ad84.js";import"./react-resizable-panels-2ebb3bd3.js";import"./xgplayer-ac1eb2ea.js";import"./lodash-es-039c886b.js";import"./@ckeditor-6ab12b32.js";import"./color-convert-d47c3cb3.js";import"./color-name-b7949e8c.js";import"./emoji-picker-element-ec9d8710.js";import"./tslib-b745fb4d.js";import"./lodash-858845ea.js";import"./intersection-observer-90e9e37b.js";import"./react-fast-compare-922b1222.js";const de="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAa1JREFUSEvNlD0vREEUhp9jI4jEFho6X6EQhaio+AMa0Usk4g/YtSgU2ItQIxGlQscf0KDVKAgbHY1CIZFsOMzdbNyPmetugphmijnnfeY958wItSxPLxGUvAymTZO0gX7cuqq/5yV1XurAnwHMaD3ddHFHiT0px9wlOfA0C0wD+8zLczU37GBd+4A+hGduOY9BXICK+BFCP+9sU5AtO8A46GEEJWuF2ABBcbhCmXQ7MNgkSBTwjbiRszfZBSnqqG+9IKekEHcDok7eOGNBnkJN93Tks+ZHWMoSjEseU+Okg5aYeFXBQAwgMDXRyavtHdT0KivBQlEnyNBqzS1zwqI8JOoWdYgMu46Y698FKDd/UKIk/8vaSANtFOTeGubpABlKzMmLS8btwIg3MYXSjnIQgxjxOlaBEsKiC2IHBMXhkVcOWJZX1rTXv+mC3LCpzbyzhtCZBIkDXOJGeEN3fEBOZv09BSQMSBK3AVJAwoBVHSOD+W++yhLsXtRB9Szs5JCcHNq/a+OgnmHKXPg1jy4XoOpEGUc4Dja8tneQBHDM6T8DeLrkX3ReVtL+ex8qOd51km0Q4QAAAABJRU5ErkJggg==",ue="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAk9JREFUSEu1Vk1W2mAUvTc9R5zVYQeVwArESWFIVyCuoLCC4gq0K6iuQFxBwwrqMHQirqAJdtChzgzn9Hs93/uSACGE2iOZfi/vvt97H1HxSeddA7J3ArALoAGipeaCKYAIkFtwPmb4O9rkhmUP6hh75wD7VQEs3mQEzL+UAa0ByIfDHuhdgzhIHcQQCUATrICJ1wPZA+CnWT1CzIA/HlbsVgCkc9gHvOvcsTHD4g/FjDQgz7vMgWAGDB9GmV0OkBp+c9HIGInX5zR6XHaoNgCKoNJqHKBmRiBP1N6Y08xGAVwza3daFpExJzN1tBZtxxcFCOPy3rXrgYIIHsHk2PYkBaiPAH4CEOOZrWLkGZBsA7CZ7IudMB+QG4azPt3E1H4WU/ufDLQarieu1EialHZ9CPKrjZ5h3Kgay20ZLGVq98KHyJkFSOsmV5zMhq8C0K5fgvys/ZS2PwVxBPz5yPDX7asAdN53gTff7cYzS3snAHbidg+w2xLdv6zJbV83m5M446nSlslqk/MxjRjGzcom20WyAAUKKdl4N6aWl160aHZnAOFkdrUpkFXCTJpFqojwzOOyCCUbPfVcPtJKevtyp+KUUcUS2dl9eAtBwEl8up62EqLlGYBJq0xcFkuLp8xmA10jQMLBtlrn1KB0LVakHAsX6XrBISuCE8GYs62C40Tq3JVFvZcLTg7iJHOk5XJfpJLpFSTT5JLpHAueIKZfKZmLTFT0L1KNqJrc9E1ugPnFP4n+srf0bLF17QK0Z8tRGu09IHbW7dkSVJ0tfwHCGWZ55xL+bQAAAABJRU5ErkJggg==",pe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAYCAYAAADpnJ2CAAAAAXNSR0IArs4c6QAAAUlJREFUSEu11stRwzAQBuB/cQGkE9JBXAKqAE7JcMqENAB3sM0x5hCnAtFBQgeUEDqAK8QsyEFBythgK6wvHo0en6TZlUTo8KW57n8w4ulIZR26eU2pbUeDMWjJzHfTkbpq22+/XSvQYgB6zHwtCrqYma0ouI+JgnWYGNiEiYC/YVXEMS9A0dyNPirL58mFWqdz3eP36MTWEcrXyVA9mXJ6r2PmiL0o/RNryAUbSNtBafnTjB8vhyo25SR/YPPfgaGYu82twUOwzuChWGcwyfUKoEHoUdUZrCLrDRmIzkLRoKBJZroIRYPAKnQD0WBwmy86A2jcuL3MCzpC4dVvsLaJjw36uzrGi5v4Xh66A9zm+pxA3mli68VuiyZUDDQrqkNFQYPezPQpAQURHYvcFnXB8v14WhlUfIV2Ahb9etdkom8ad8X/8Uz8BPWtPBLq1JROAAAAAElFTkSuQmCC",Ae="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAAAXNSR0IArs4c6QAAAvtJREFUSEu9VrFyElEUPfcxpA1+gaSxDX5BSGsTXmllKFzGsRBYrSW9QFI5kCLEwvbhF0j+AL8g2NhYhLQm7HHewrLLsizLOON2LG/vufe8c8+9gv/8yC547b45FeDU/4aYyB7qjaqe7hIjM2C7Z1oi8jEanOQPtYfyLqArgO2eqYug2HR0PRq4e2UKfJA7vzCyoRTGnodzETm0v92aPs9aZRzQr4LAwHUq1SBIp2/OAXkH8Kbp6LJ9H1bMG5nhtPFGT7KArlHa6ZsRIEcWVM145uUwEsjTeTB+azq6sgCsi0g3ACFYdR092Aa6Bmjp8/5gZOkCeAGiQKBEoPW+pocrVH82RSq0IPJqQfeZW9OtNNBE0URBPcze5vLqa5ow5uqVKwvkkTqeWDSBREArHgp/C+WDL4wMdM0FJ12CP11HFzdVuYnSiYjszx4fD1Uu9yUzaN9M7H2nJbgG+KlnKkrE2B5za7q0oNdPYFulIbWhuOKVrgEGcie5FEC3b0oefSHtp91R14ooJ7dptG5si3jgCCgFPG44epx0T53+kPa95PkkSWjrFS7uQcDn8aBZQIM+FuFx47UebaU0yLDpVJJbJqQ3sdJOzwxsX26yvJWg3UtTJuV71MKSaAvPYRqnN2J5F3FP9qmOBlyqjLxu1vR8DG14Is0+lTwPgvvalvQKYGDSUYVmBB1LnscWNJgsJO/dmi6k3uG2C08Cj1S6BG33zNS2UJJS4+NpfnDGg6zjxp8coZf6oHzA0E6cJKXGKE3voVR6w41gTPCXQF5kADQ2s5Ndp3iQSNASAMYCVpHHJN78KxUGPjqftbwWpW79keN5IqLums7Jxco8vDRlQB0F7+w5EM9Eycv41hCcSXKa5WxbU1jMPdoLV4qeswoXoOg3f2xVWevD4ENrwp5arIO2WQWlBdX3ENRJTJXYHQdla9QglquFUhhZSwvp5YoBZF4TI/ezLMj2mhKUNxu51QQmUcfJDBjKH3aJKpAYqj0MdtlJN1KaJv9//e8vNt/rLDoq9U0AAAAASUVORK5CYII=",R={"conversation-item":"_conversation-item_1cdkq_1","conversation-item-pined":"_conversation-item-pined_1cdkq_4"},y=({title:t,className:e,onClick:s})=>r("div",{className:S("cursor-pointer rounded px-3 py-2 text-xs hover:bg-[var(--primary-active)]",e),onClick:s,children:t}),ge=g.memo(({conversation:t,closeConversationMenu:e})=>{const s=z(),[n,c]=g.useState(!1),f=h(m=>m.delConversationByCID),l=h(m=>m.updateCurrentConversation),d=h(m=>m.updateCurrentConversationFields),u=async()=>{c(!0);try{await v.pinConversation({conversationID:t.conversationID,isPinned:!t.isPinned})}catch(m){w({error:m,msg:a("toast.pinConversationFailed")})}c(!1),e()},o=async()=>{var m;c(!0);try{await v.deleteConversationAndDeleteAllMsg(t.conversationID),f(t.conversationID),t.conversationID===((m=h.getState().currentConversation)==null?void 0:m.conversationID)&&(l(),s("/chat"))}catch(N){w({error:N,msg:a("toast.deleteConversationFailed")})}c(!1),e()},p=async()=>{c(!0);try{await v.markConversationMessageAsRead(t.conversationID),d({unreadCount:0})}catch(m){w({error:m})}c(!1),e()};return r(Q,{spinning:n,children:A("div",{className:"p-1",children:[r(y,{title:t.isPinned?a("placeholder.removeSticky"):a("placeholder.sticky"),onClick:u}),!!t.unreadCount&&r(y,{title:a("placeholder.markAsRead"),onClick:p}),r(y,{className:"text-[#FF381F]",title:a("placeholder.remove"),onClick:o})]})})});function fe({domRef:t,currentConversation:e}){const[s,n]=g.useState(!1),{createFileMessage:c}=Y(),{sendMessage:f}=q(),l=()=>{s&&n(!1)};return me(t.current,{onText:(d,u)=>{u==null||u.preventDefault(),l()},onFiles:async(d,u)=>{if(!await J(e)){l();return}d.length&&M.confirm({title:"".concat(a("placeholder.sendTo")).concat(e.showName),icon:null,width:320,centered:!0,className:"drop-file-moal",content:r("div",{className:"h-[240px] overflow-y-auto border-b border-t border-[var(--gap-text)] p-2",children:d.map(o=>A("div",{className:"mb-2 flex items-center",children:[r("img",{width:38,src:b,alt:"file"}),A("div",{className:"ml-3 overflow-hidden",children:[r("div",{className:"mb-1.5 truncate",children:o.name}),r("div",{className:"text-xs text-[var(--sub-text)]",children:U(o.size)})]})]},o.lastModified))}),okText:a("confirm"),cancelText:a("cancel"),onOk:()=>{d.map(async o=>{const p=await c(o);f({message:p,recvID:e.userID,groupID:e.groupID})})}}),l()},onUri:(d,u)=>{u==null||u.preventDefault(),l()},onDom:async({message:d},u)=>{if(!await J(e)){l();return}const{fileName:o,fileSize:p}=he(d);M.confirm({title:"".concat(a("placeholder.sendTo")).concat(e.showName),icon:null,width:320,centered:!0,className:"drop-file-moal",content:r("div",{className:"h-[240px] overflow-y-auto border-b border-t border-[var(--gap-text)] p-2",children:A("div",{className:"mb-2 flex items-center",children:[r("img",{width:38,src:b,alt:"file"}),A("div",{className:"ml-3 overflow-hidden",children:[r("div",{className:"mb-1.5 truncate",children:o}),r("div",{className:"text-xs text-[var(--sub-text)]",children:U(p)})]})]})}),okText:a("confirm"),cancelText:a("cancel"),onOk:async()=>{const m=(await v.createForwardMessage(d)).data;f({message:m,recvID:e.userID,groupID:e.groupID})}}),l()},onDragEnter:()=>{s||n(!0)},onDragLeave:l}),{droping:s}}const J=async t=>{if(t!=null&&t.userID)return!0;const{data:e}=await v.getSpecifiedGroupMembersInfo({groupID:t.groupID,userIDList:[D.getState().selfInfo.userID]}),s=e[0];if(!s)return!1;const{data:n}=await v.getSpecifiedGroupsInfo([t.groupID]),c=n[0];return c&&c.status===T.Dismissed||c.status===T.Muted&&s.roleLevel===ae.Normal?!1:s.muteEndTime<Date.now()},he=t=>{var e,s;if(t.contentType===P.PictureMessage){const n=(s=(e=t.pictureElem.sourcePath)==null?void 0:e.lastIndexOf("/"))!=null?s:-1;return{fileName:n>-1?t.pictureElem.sourcePath.slice(n+1):a("placeholder.file"),fileSize:t.pictureElem.sourcePicture.size}}if(t.contentType===P.VideoMessage){const n=t.videoElem.videoPath.lastIndexOf("/");return{fileName:n>-1?t.videoElem.videoPath.slice(n+1):a("placeholder.file"),fileSize:t.videoElem.videoSize}}return{fileName:t.fileElem.fileName,fileSize:t.fileElem.fileSize}},ve=({isActive:t,conversation:e})=>{const s=z(),n=g.useRef(null),[c,f]=g.useState(!1),[l,d]=g.useState(!1),u=h(i=>i.updateCurrentConversation),o=D(i=>i.selfInfo.userID),{droping:p}=fe({domRef:n,currentConversation:e}),m=()=>{t||(u({...e}),s("/chat/".concat(e.conversationID)))},N=()=>{f(!1)},O=()=>{if(e.draftText&&!t)return a("messageDescription.drftPrefix");let i="";if(C&&e.unreadCount>0&&(i=a("messageDescription.unreadCount",{count:e.unreadCount})),B)switch(e.groupAtType){case x.AtAll:i=a("messageDescription.atAllPrefix");break;case x.AtMe:i=a("messageDescription.atYouPrefix");break;case x.AtAllAtMe:i=a("messageDescription.atYouPrefix");break;case x.AtGroupNotice:i=a("messageDescription.groupAnnouncementPrefix");break}return i},B=e.groupAtType!==x.AtNormal,L=e.conversationType===ne.Notification;g.useEffect(()=>{try{if(!e.latestMsg)return;JSON.parse(e.latestMsg).status===oe.Sending?d(!0):d(!1)}catch(i){console.error("parse latestMsg error",i)}},[e.latestMsg]);const H=g.useMemo(()=>{let i="";if(e.draftText&&!t){const E=new DOMParser().parseFromString(e.draftText,"text/html");E.querySelectorAll("img").forEach(F=>{const I=F.parentNode;I==null||I.replaceChild(document.createTextNode(a("messageDescription.imageMessage")),F)}),i=E.body.innerHTML}else if(e.latestMsg)try{i=V(JSON.parse(e.latestMsg))}catch(G){i=a("messageDescription.catchMessage")}return j(i)},[e.draftText,e.latestMsg,t,o]),K=X(e.latestMsgSendTime),C=e.recvMsgOpt!==ie.Normal;return r(W,{overlayClassName:"conversation-popover",placement:"bottomRight",title:null,arrow:!1,open:c,onOpenChange:i=>f(i),content:r(ge,{conversation:e,closeConversationMenu:N}),trigger:"contextMenu",children:A("div",{ref:n,className:S(R["conversation-item"],"border border-transparent",(t||e.isPinned)&&"bg-[var(--primary-active)]",e.isPinned&&R["conversation-item-pinned"],p&&"!border-[var(--primary)]"),onClick:m,children:[r(Z,{size:"small",count:C?0:e.unreadCount,children:r(_,{src:e.faceURL,isgroup:!!e.groupID,isnotification:L,text:e.showName})}),A("div",{className:"ml-3 flex h-11 flex-1 flex-col justify-between overflow-hidden",children:[A("div",{className:"flex items-center justify-between",children:[r("div",{className:"flex-1 truncate font-medium",children:e.showName}),r("div",{className:"ml-2 text-xs text-[var(--sub-text)]",children:K})]}),A("div",{className:"flex items-center",children:[A("div",{className:"flex min-h-[16px] flex-1 items-center overflow-hidden text-xs",children:[r("div",{className:S("mr-px whitespace-nowrap text-[var(--primary)]",{"!text-[var(--sub-text)]":C&&!B}),children:O()}),l&&r("img",{src:pe,alt:"conversation_sending",className:"mr-1 h-3 w-[14px]"}),r("div",{className:"truncate text-[rgba(81,94,112,0.5)]",dangerouslySetInnerHTML:{__html:H}})]}),r("img",{className:C?"visible":"invisible",src:Ae,width:14,alt:"disturb"})]})]})]})})},xe=g.memo(ve),Ce=()=>r("div",{className:"my-1 flex p-3",children:r($,{avatar:{shape:"square"},active:!0,title:!0,paragraph:{rows:1}})}),Se="_loading_nklkj_9",Ne={loading:Se};function Ie(t,e){let s=e+1,n=0;for(;n<t.length;){if(s>=t.length&&(s=0),t[s].unreadCount>0)return s;s++,n++}return-1}function we(t){const e=[];for(let s=0;s<t;s++)e.push({conversationID:"skeleton-".concat(s)});return e}const ye=()=>{const t=D(),e=t.syncState==="loading"||t.connectState==="loading",s=t.syncState==="failed"||t.connectState==="failed",n=t.syncState==="loading"?a("connect.syncing"):a("connect.connecting"),c=t.syncState==="failed"?a("connect.syncFailed"):a("connect.connectFailed");return t.reinstall?null:A(ee,{children:[e&&A("div",{className:"flex h-6 items-center justify-center bg-[#0089FF] bg-opacity-10",children:[r("img",{src:de,alt:"sync",className:S("mr-1 h-3 w-3 ",Ne.loading)}),r("span",{className:" text-xs text-[#0089FF]",children:n})]}),s&&A("div",{className:"flex h-6 items-center justify-center bg-[#FF381F] bg-opacity-15",children:[r("img",{src:ue,alt:"sync",className:"mr-1 h-3 w-3"}),r("span",{className:" text-xs text-[#FF381F]",children:c})]})]})},De=()=>{const{conversationID:t}=ce(),e=h(o=>o.conversationList),s=h(o=>o.conversationIniting),n=h(o=>o.getConversationListByReq),c=g.useRef(null),f=g.useRef(!0),l=g.useRef(0);g.useEffect(()=>{const o=()=>{var p;l.current=Ie(h.getState().conversationList,l.current),l.current>-1&&((p=c.current)==null||p.scrollToIndex({index:l.current,behavior:"smooth"}))};return k.on("TRY_JUMP_TO_UNREAD",o),()=>{k.off("TRY_JUMP_TO_UNREAD",o)}},[]);const d=async()=>{f.current&&(f.current=await n(!0))},u=g.useMemo(()=>s?we(20):e,[s,e]);return A("div",{children:[r(ye,{}),r(se,{needHidden:!!t,wrapClassName:"left-2 right-2 top-1.5 flex flex-col",children:r(re,{className:"flex-1",data:u,ref:c,endReached:d,computeItemKey:(o,p)=>p.conversationID,itemContent:(o,p)=>s?r(Ce,{}):r(xe,{isActive:t===p.conversationID,conversation:p})})})]})},Ft=()=>A(te,{className:"flex-row",children:[r(De,{}),r(le,{})]});export{Ft as Chat};
